# Setting up your GitHub Pages site locally with Jekyll

This repository holds the content of [SQLFlow.org](https://sql-machine-learning.github.io/). We rely on the [Github Pages](https://pages.github.com/) to convert Markdown files in this repo into HTML files. Github pages calls the converter [Jekyll](https://jekyllrb.com/docs/) , which churns through layout and other decorations.  In addition, we use Jekyll to call [Just-the-Doc](https://pmarsceill.github.io/just-the-docs/) to generate the corresponding documents.

## Repo Walkthrough

We see the following files and directories at the root of this repository:

- `Gemfile` lists Ruby dependencies required by Jekyll to build this repository into a website.
- `index.md`, `_config.yml`, `_data`, `_layouts` are [what Jekyll needs](https://jekyllrb.com/docs/structure/) to build the website.
- `pages` holds Jekyll [Pages](https://jekyllrb.com/docs/pages/).
- `assets` includes figures, images, and Javascript files.
- `doc_index` holds template files of categories of documents generated by Jekyll and Just-the-Doc.
- `gohive`, `gomaxcompute`, `pysqlflow`, `sqlflow` are git-submodules to other repositories in the same organization.  Jekyll and Just-the-Doc convert Markdown files in these git-submodules and listed in `/_config.yml` into the documentation.  Also, `index.html` files in these subdirectories redirect URLs like https://sqlflow.org/gohive to https://github.com/sql-machine-learning/gohive

## Instructions for serving a local SQLFlow website 

To run SQLFlow website we need to install Jekyll and its dependencies. However, there are different versions of Jekyll, making it hard to reproduce runtime errors. Therefore, we recommend using dockerized Jekyll, which includes a specifici version (3.8) of Jekyll and the dependencies in the image. Note for Mac users, please install [Docker for Desktop](https://hub.docker.com/editions/community/docker-ce-desktop-mac); other tools like Docker Toolbox cannot expose Jekyll port in the local host.

**Step One**: Clone SQLFlow repo to your local machine. For potential contributors, please fork the repo and then make a clone.

```bash
git clone https://github.com/sql-machine-learning/sql-machine-learning.github.io
```

**Step Two**: Update markdown files. Most of the document markdown files and redirect `index.html` files can be found in the adjacent repos like SQLFlow, GoHive, PySQLFlow. To include them into the website, we create git submodules like `/sqlflow` then point them to the right repo. If you are going through the instruction for the first time, please use below command to include the markdown files before running Jekyll serve. Whenever there are updates to markdown file in other repo, please run the command again without --init to update the content. Otherwise, the updated content won't show up. 

```bash
git submodule update --init --recursive --remote
```

**Step Three**: Fire up docker run under the repo root. Note the command will pull the image from the remote automatically. Also, make sure to replace `b90ffea2` with your personal access token. It takes a few seconds to generate the token by following [this document](https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line). Now you can access SQLFlow.org from http://localhost:4000 with exactly the same content.

```bash
cd sql-machine-learning.github.io
docker run --rm -it \
   -v $PWD:/srv/jekyll \
   -e JEKYLL_GITHUB_TOKEN=b90ffea2 \
   -p 4000:4000 \
   jekyll/jekyll:3.8 \
   jekyll serve --incremental
```

## Jekyll Pages, Documents, and Redirects

The generated website serves the four kinds of contents below:

1. Jekyll [Pages](https://jekyllrb.com/docs/pages/).  

   Each source file is a Markdown file in directories like `/` and `/pages`.  In the [front matter](https://jekyllrb.com/docs/front-matter/) of the Markdown file, the `layout` tag refers to a layout template file. For example, in `/index.md` there is a line:

   ```yaml
   layout: index
   ```
   $ ruby --version
   > ruby 2.X.X
   ```
1. Install Bundler:
   ```
   $ gem install bundler
   # Installs the Bundler gem
   ```
1. Install Jekyll and other [dependencies](https://pages.github.com/versions/) from the GitHub Pages gem:
   ```
   $ bundle install
   > Fetching gem metadata from https://rubygems.org/............
   > Fetching version metadata from https://rubygems.org/...
   > Fetching dependency metadata from https://rubygems.org/..
   > Resolving dependencies...
   ```
1. Run your Jekyll site locally:
   ```
   $ bundle exec jekyll serve
   > Configuration file: /Users/octocat/my-site/_config.yml
   >            Source: /Users/octocat/my-site
   >       Destination: /Users/octocat/my-site/_site
   > Incremental build: disabled. Enable with --incremental
   >      Generating...
   >                    done in 0.309 seconds.
   > Auto-regeneration: enabled for '/Users/octocat/my-site'
   > Configuration file: /Users/octocat/my-site/_config.yml
   >    Server address: http://127.0.0.1:4000/
   >  Server running... press ctrl-c to stop.
   ```
1. Preview your local Jekyll site in your web browser at http://localhost:4000.

